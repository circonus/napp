#!/bin/bash
PID=$1

if [ -r /opt/noit/prod/etc/noit.env ]; then
	. /opt/noit/prod/etc/noit.env
fi
if [ -r /opt/noit/prod/etc/noit.local.env ]; then
	. /opt/noit/prod/etc/noit.local.env
fi

if [ ! -x /opt/backtrace/bin/ptrace ]; then
	echo "Process $PID has crashed."
	echo "Noit version: $NOIT_VERSION"
	echo "No tracer installed."
	exit
fi

echo "Invoking tracer against $PID."

if [ -r /opt/napp/etc/ssl/appliance.crt ]; then
	HOSTCN=`openssl x509 -in /opt/napp/etc/ssl/appliance.crt -subject | gawk -F'= ' '/^subject= (.+)/{print $2;}' | sed -e 's/.*CN=//g;' -e 's#/.*##g;'`
fi

/opt/backtrace/bin/ptrace --print --config=/opt/noit/prod/etc/ptrace.conf \
	--kv=hostcn:$HOSTCN,location:$LOCATION,provider:$PROVIDER,environment:$ENVIRONMENT \
	--kv=branch:$NOIT_BRANCH,version:$NOIT_VERSION,version_tstamp:$NOIT_VERSION_TSTAMP,buildmachine:$BUILD_UNAME_N \
	$PID

