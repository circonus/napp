#!/bin/sh

NOITD=/opt/noit/prod/sbin/noitd
CONF=/opt/noit/prod/etc/noit.conf
USER=broker
GROUP=broker
WRITE_PATHS=" \
	/opt/napp/etc/ssl \
	/opt/noit/prod/log \
	/opt/noit/prod/etc \
"

# Potentially move old SSL from /opt/napp/etc/ssl to /opt/noit/prod/etc/ssl
if [ -d /opt/napp/etc/ssl ]; then
	echo "Relocating SSL credentials"
	(cd /opt/napp/etc && find ssl -print | cpio -pvd /opt/noit/prod/etc && rm -rf /opt/napp/etc)
fi

if [ -x /usr/gnu/bin/awk ]; then
	AWK="/usr/gnu/bin/awk"
else
	AWK="awk"
fi

set -o allexport
if [ -r /opt/noit/prod/etc/noit.env ]; then
	. /opt/noit/prod/etc/noit.env
fi
if [ -r /opt/noit/prod/etc/noit.local.env ]; then
	. /opt/noit/prod/etc/noit.local.env
fi

# Detect if we have no process management and if coroner management
# has not been explicitly set.  If this is the case, we should run
# with coroner managed.
if [ -z "$MANAGED_CORONER" ]; then
	if [ "$$" -eq "1" -a -x "/opt/backtrace/bin/coroner" ]; then
		MANAGED_CORONER=1
	fi
fi

set +o allexport

# Just in case, chown this stuff
for dir in $WRITE_PATHS; do
	/bin/chown -R $USER:$GROUP $dir 2>/dev/null
done

test ! \( -f /opt/napp/etc/ssl/graphite.key -a -f /opt/napp/etc/ssl/graphite.crt -a -f /opt/napp/etc/ssl/graphite-ca.crt \)
export SNI_GRAPHITE=$?

exec $NOITD -c $CONF -u $USER -g $GROUP $*
exit 2
