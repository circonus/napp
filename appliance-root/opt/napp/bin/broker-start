#!/bin/sh

CONF=/opt/noit/prod/etc/noit.conf
USER=broker
GROUP=broker
WRITE_PATHS=" \
	/opt/napp/etc/ssl \
	/opt/noit/prod/log \
	/opt/noit/prod/etc \
"

set -o allexport
if [ -r /opt/noit/prod/etc/noit.env ]; then
	. /opt/noit/prod/etc/noit.env
fi
if [ -r /opt/noit/prod/etc/noit.local.env ]; then
	. /opt/noit/prod/etc/noit.local.env
fi
set +o allexport

# Just in case, chown this stuff
for dir in $WRITE_PATHS; do
	/bin/chown -R $USER:$GROUP $dir
done

# Update bits

# upgrade for conf change 4f43782
HAS_LOADER=`grep '<loader image="lua" name="lua">' $CONF 2>/dev/null`
if [ -n "$HAS_LOADER" ]; then
	sed -ie '/<loader image="lua" name="lua">/,/<\/loader>/d' $CONF
fi

exec /opt/noit/prod/sbin/noitd -c /opt/noit/prod/etc/noit.conf -u $USER -g $GROUP $*
exit 2
