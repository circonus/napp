#!/bin/sh

OPENSSL=/bin/openssl
test -x $OPENSSL || OPENSSL=/usr/sfw/bin/openssl
test -x $OPENSSL || OPENSSL=/opt/local/bin/openssl

if [ -n "$1" ] && [ "$1" = "0" ]; then
	STUTTER=0
else
	# 14 * 2^8 is about the number of seconds in an hour
	STUTTER=`$OPENSSL rand 1 | od -t u1 | awk '/0000000/ {print 14*$2}'`
fi

sleep $STUTTER

TMPCRL=/opt/napp/etc/ssl/ca.$$.crl
CRL=/opt/napp/etc/ssl/ca.crl

curl -s -o $TMPCRL http://s.circonus.com/pki/ca.crl
openssl crl -CAfile /opt/napp/etc/ssl/ca.crt -text -in $TMPCRL >/dev/null 2>&1 
if [ $? -eq 0 ]; then
	cmp -s "$TMPCRL" "$CRL"
	if [ ! -r $CRL -o $? -ne 0 ]; then
		ln -f $TMPCRL $CRL
	fi
fi

rm -f $TMPCRL
