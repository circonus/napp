#!/bin/sh

NOW=`date +%Y%m%d%H%M%S`
LOG=/opt/napp/etc/updatelogs/$NOW.log

if [ ! -r /opt/napp/etc/doupdate ]; then
	if [ -r /opt/napp/etc/autoupdate ]; then
		UPDATES=`/opt/napp/etc/check-for-updates | awk '{if(NF==3){n++;}} BEGIN {n=0;} END {print n;}'`
		if [ "$UPDATES" -gt "0" ]; then
			touch /opt/napp/etc/doupdates
		fi
	fi
fi
if [ -r /opt/napp/etc/doupdates ]; then
	mv /opt/napp/etc/doupdates /opt/napp/etc/doingupdates

	case `uname` in
		SunOS)
			if [ -n "`grep OmniOS /etc/release`" ]; then
				/opt/napp/bin/omnios-canupdate.sh > $LOG 2>&1
			elif [ -x /opt/local/sbin/pkg_add ]; then
				# Joyent SmartOS
				/opt/napp/bin/smartos-update.sh > $LOG 2>&1
			else
				/opt/napp/bin/sol11-update.sh > $LOG 2>&1 
			fi
			;;

		*)	yum -y update > $LOG 2>&1
			;;
	esac

	rm /opt/napp/etc/doingupdates
fi
